var Domo,EventEmitter,Router,colors,fs,irc,pack,registerDefaultRoutes,_,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e},__slice=[].slice;fs=require("fs"),irc=require("irc"),colors=require("colors"),Router=require("routes"),EventEmitter=require("events").EventEmitter,_=require("underscore"),_.str=require("underscore.string"),pack=JSON.parse(fs.readFileSync(""+__dirname+"/package.json")),registerDefaultRoutes=function(e){return e.route("!domo",function(t){var r;return e.say(t.channel,"h :) v"+pack.version+"\nCurrent channels: "+function(){var t;t=[];for(r in e.channels)t.push(r);return t}().join(", ")+"\nI live here: "+pack.repository.url)}),e.route("!auth :username :password",e.authenticate,function(t){return e.say(t.channel,"You are now authed. Hi "+_.str.capitalize(t.user.username)+"!")}),e.route("!join :channel",e.requiresUser,function(t){return e.join(t.params.channel)}),e.route("!join :channel :password",e.requiresUser,function(t){return e.join(t.params.channel+" "+t.params.password)}),e.route("!part :channel",e.requiresUser,function(t){return e.part(t.params.channel)}),e.route("!load :module",e.requiresUser,function(t){return e.load(t.params.module,function(r){return null!=r?e.say(t.channel,r):e.say(t.channel,"Module '"+t.params.module+"' loaded!")})}),e.route("!stop :module",e.requiresUser,function(t){return e.stop(t.params.module,function(r){return null!=r&&e.say(t.channel,r),e.say(t.channel,"Module '"+t.params.module+"' stopped!")})})},Domo=function(e){function t(e){var t,r,n,o;if(this.config=e,this.stop=__bind(this.stop,this),this.load=__bind(this.load,this),this.say=__bind(this.say,this),this.router=new Router,this.modules={},this.authedClients=[],this.middlewares=[],this.config=this.config||{},this.use(this.constructRes),registerDefaultRoutes(this),null!=this.config.modules)for(o=this.config.modules,r=0,n=o.length;n>r;r++)t=o[r],this.load(t)}return __extends(t,e),t.prototype.error=function(e){return null!=this.config.debug?console.log("Error:".red,e.red):void 0},t.prototype.notify=function(e){return console.log("Notify:".green,e.green)},t.prototype.say=function(e,t){return this.client.say(e,t)},t.prototype.join=function(e,t){return this.client.join(e,t)},t.prototype.part=function(e,t){return this.client.part(e,t)},t.prototype.load=function(e,t){var r,n,o;try{n=require(e)}catch(i){return r=i,o="Module "+e+" not found",this.error(o),"function"==typeof t?t(o):void 0}return this.modules.hasOwnProperty(e)?(o="Module "+e+" already loaded",this.error(o),"function"==typeof t?t(o):void 0):(this.notify("Loaded module "+e),this.modules[e]=n,"function"==typeof n.init&&n.init(this),"function"==typeof t?t(null):void 0)},t.prototype.stop=function(e,t){var r;return this.modules.hasOwnProperty(e)?(delete require.cache[require.resolve(e)],delete this.modules[e],this.notify("Stopped module "+e),"function"==typeof t?t(null):void 0):(r="Module "+e+" not loaded",this.error(r),"function"==typeof t?t(r):void 0)},t.prototype.connect=function(){var e=this;return this.client=new irc.Client(this.config.address,this.config.nick,this.config),this.client.addListener("error",function(t){return e.error(t),e.emit.apply(e,arguments)}),this.client.addListener("registered",function(){return e.notify("Connected to server "+e.config.address+".\n	Channels joined: "+e.config.channels.join(", ")),e.emit.apply(e,arguments)}),this.client.addListener("message",function(t,r,n,o){return e.emit.apply(e,arguments),e.match(n,o)}),this.channels=this.client.chans,this.client},t.prototype.route=function(){var e,t,r,n;return r=arguments[0],t=arguments.length>=3?__slice.call(arguments,1,n=arguments.length-1):(n=1,[]),e=arguments[n++],this.router.addRoute(r,this.wrap(e,t))},t.prototype.match=function(e,t){var r;if(null!=(r=this.router.match(e)))return r.fn.call(this,_.extend(r,t))},t.prototype.wrap=function(e,t){var r=this;return function(){var n;return n=Array.prototype.slice.call(arguments,0),_.reduceRight(r.middlewares.concat(t),function(e,t){var o;return o=function(){return e.apply(r,n)},function(){return t.apply(this,_.flatten([n,o],!0))}},e).apply(r,arguments)}},t.prototype.use=function(e){return this.middlewares.push(e)},t.prototype.constructRes=function(e,t){return e.channel=e.args[0],e.message=e.args[1],e.username=e.user,e.user=this.authedClients.hasOwnProperty(e.prefix)?this.authedClients[e.prefix]:null,t()},t.prototype.authenticate=function(e,t){var r;return null==this.config.users?this.error("Tried to authenticate. No users configured"):this.authedClients.hasOwnProperty(e.prefix)?this.say(e.channel,"You are already authed."):(r=e.user=_.findWhere(this.config.users,{username:e.params.username,password:e.params.password}),null==r?(this.error("User "+e.prefix+" tried to authenticate with bad credentials"),this.say(e.channel,"Authentication failed. Bad credentials.")):(this.authedClients[e.prefix]=r,t()))},t.prototype.requiresUser=function(e,t){return null==e.user?this.error("User "+e.prefix+" tried to use '"+e.route+"' route"):t()},t}(EventEmitter),module.exports=Domo;